<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GF Motor | å°ˆæ¥­æ”¹è£ãƒ»ä¿é¤Šãƒ»ç¶­ä¿®</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
    <style>
        /* --- å…¨åŸŸè¨­å®š --- */
        body { margin: 0; font-family: 'Segoe UI', Roboto, sans-serif; background: #f8f9fa; color: #333; display: flex; flex-direction: column; min-height: 100vh;}
        a { text-decoration: none; }
        
        /* éš±è—å°ˆç”¨ class */
        .hidden { display: none !important; }

        /* --- 1. å°è¦½åˆ— (Navbar) --- */
        nav {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px 40px; background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky; top: 0; z-index: 1000;
        }
        .logo { font-size: 1.5rem; font-weight: 900; color: #111; letter-spacing: 1px; }
        .logo span { color: #e74c3c; }

        .nav-links { display: flex; gap: 20px; align-items: center; }
        
        .btn-portfolio {
            color: #555; font-weight: 500; padding: 8px 15px; border-radius: 20px; transition: 0.3s;
            border: 1px solid transparent;
        }
        .btn-portfolio:hover { background: #f0f0f0; color: #111; }

        .btn-login {
            background: #111; color: white; padding: 8px 20px; border-radius: 20px; 
            font-weight: bold; cursor: pointer; border: none; transition: 0.3s;
        }
        .btn-login:hover { background: #e74c3c; }

        /* --- 2. å½¢è±¡å€å¡Š (Hero Section) --- */
        #landingSection {
            text-align: center; padding: 80px 20px;
            background: linear-gradient(135deg, #2c3e50 0%, #000000 100%);
            color: white; flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        #landingSection h1 { font-size: 3rem; margin: 0 0 20px 0; }
        #landingSection p { font-size: 1.2rem; color: #ccc; max-width: 600px; margin-bottom: 40px; }
        
        .hero-btn {
            display: inline-block; padding: 15px 40px; background: #e74c3c; color: white; 
            font-size: 1.2rem; border-radius: 50px; font-weight: bold; transition: 0.3s; cursor: pointer;
            margin-bottom: 30px;
        }
        .hero-btn:hover { transform: scale(1.05); box-shadow: 0 0 20px rgba(231, 76, 60, 0.5); }

        /* â˜…â˜…â˜… æ–°å¢ï¼šç¤¾ç¾¤æŒ‰éˆ•å€å¡Š (Heroä¸‹æ–¹) â˜…â˜…â˜… */
        .social-icons { display: flex; gap: 20px; justify-content: center; }
        .social-link {
            width: 50px; height: 50px; border-radius: 50%; background: rgba(255,255,255,0.1);
            display: flex; align-items: center; justify-content: center;
            color: white; font-size: 1.5rem; transition: 0.3s; border: 1px solid rgba(255,255,255,0.2);
        }
        .social-link:hover { background: white; transform: translateY(-3px); }
        .social-link.line:hover { color: #06c755; } /* LINE ç¶  */
        .social-link.ig:hover { color: #e1306c; }   /* IG ç²‰ */
        .social-link.fb:hover { color: #1877f2; }   /* FB è— */
        .social-link.threads:hover { color: #000000; background: white; }


        /* --- 3. æœƒå“¡åŠŸèƒ½å€å¡Š --- */
        #appContainer {
            max-width: 450px; margin: 50px auto; background: white; padding: 2rem; 
            border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        /* --- 4. é å°¾å€å¡Š (Footer) --- */
        footer {
            background: #111; color: #777; padding: 40px 20px; text-align: center;
            font-size: 0.9rem; border-top: 1px solid #333; margin-top: auto;
        }
        footer p { margin: 5px 0; }
        .footer-links a { color: #aaa; margin: 0 10px; transition: 0.3s; }
        .footer-links a:hover { color: white; text-decoration: underline; }

        /* --- å…¶ä»–åŸæœ¬çš„ CSS --- */
        .level-card { padding: 20px; border-radius: 12px; margin-bottom: 20px; text-align: left; color: white; position: relative; overflow: hidden; }
        .level-card.normal-style { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .level-card.da-gai-style { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .level-card.bao-gai-style { background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%); }
        .level-card.vvip-style { background: linear-gradient(135deg, #141e30 0%, #243b55 100%); border: 1px solid #d4af37; color: #d4af37; }
        .level-card.svip-style { background: linear-gradient(135deg, #8E2DE2 0%, #4A00E0 100%); }
        .spending-amount { font-size: 2.2rem; font-weight: 800; margin: 10px 0; }

        .btn-group { display: flex; gap: 10px; margin-bottom: 15px; }
        .btn-full { width: 100%; padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; margin-top: 10px; background: #007bff; color: white; }
        .btn-outline { flex: 1; padding: 10px; border: 1px solid #ddd; background: #f8f9fa; cursor: pointer; border-radius: 8px; }
        .btn-outline.active { background: #e7f1ff; border-color: #007bff; color: #007bff; }
        
        input, select, textarea { width: 100%; padding: 10px; margin: 5px 0 15px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        .record-item { padding: 12px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; }
    </style>
</head>
<body>

    <nav>
        <div class="logo">GF <span>Motor</span></div>
        <div class="nav-links">
            <a href="portfolio.html" class="btn-portfolio">ğŸ“¸ æ”¹è£åäººå ‚</a>
            <button id="navLoginBtn" class="btn-login" onclick="toggleLoginView()">æœƒå“¡ç™»å…¥</button>
        </div>
    </nav>

    <div id="landingSection">
        <h1>å®šç¾©ä½ çš„é€Ÿåº¦èˆ‡ç¾å­¸</h1>
        <p>GF Motor æä¾›æœ€å°ˆæ¥­çš„æ©Ÿè»Šæ”¹è£ã€ä¿é¤Šèˆ‡ç¶­ä¿®æœå‹™ã€‚<br>å¾åŸºç¤ä¿é¤Šåˆ°æ¥µè‡´çˆ†æ”¹ï¼Œæˆ‘å€‘å¯¦ç¾ä½ å°è»Šçš„æ‰€æœ‰æƒ³åƒã€‚</p>
        
        <div class="hero-btn" onclick="toggleLoginView()">ç«‹å³é ç´„ä¿é¤Š</div>

        <div class="social-icons">
            <a href="https://www.facebook.com/gf.motor" target="_blank" class="social-link fb" title="Facebook">
                <i class="fa-brands fa-facebook-f"></i>
            </a>
            <a href="https://www.instagram.com/gjufengmotor/" target="_blank" class="social-link ig" title="Instagram">
                <i class="fa-brands fa-instagram"></i>
            </a>
            <a href="https://www.threads.com/@gjufengmotor?xmt=AQF0D9VIJBdycUxBIrAfvyayidhTBSPnbazk2rBn8fKXEZ0" target="_blank" class="social-link threads" title="Threads">
                <i class="fa-brands fa-threads"></i>
            </a>
            <a href="https://lin.ee/23mk4EM" target="_blank" class="social-link line" title="å®˜æ–¹ LINE">
                <i class="fa-brands fa-line"></i>
            </a>

        </div>
    </div>

    <div id="appContainer" class="hidden">
        <div id="loginSection">
            <h2 style="text-align:center;">æ­¡è¿å›ä¾†</h2>
            <p style="text-align:center; color:#666; margin-bottom: 30px;">è«‹ç™»å…¥ä»¥ç®¡ç†æ‚¨çš„é ç´„èˆ‡æ¶ˆè²»ç­‰ç´š</p>
            <div id="buttonDiv" style="display: flex; justify-content: center;"></div>
        </div>

        <div id="phoneSection" class="hidden">
            <p>ğŸ‘‹ å—¨ï¼Œ<span id="userNameDisplay"></span><br>è«‹è£œå¡«æ‰‹æ©Ÿè™Ÿç¢¼ï¼š</p>
            <input type="text" id="phoneInput" placeholder="10ç¢¼æ‰‹æ©Ÿè™Ÿç¢¼" maxlength="10">
            <button class="btn-full" onclick="submitPhone()">é€å‡ºè³‡æ–™</button>
        </div>

        <div id="profileSection" class="hidden">
            <div id="levelCard" class="level-card normal-style">
                <div id="p_level" style="font-size: 1.2rem; font-weight:bold;">Loading...</div>
                <div style="font-size: 0.9rem; opacity: 0.8;">ç´¯ç©æ¶ˆè²»</div>
                <div class="spending-amount">$<span id="p_spending">0</span></div>
                <div style="font-size: 0.8rem;">å†æ¶ˆè²» $<span id="next_goal">...</span> å‡ç´š</div>
            </div>
            <p><strong>å§“åï¼š</strong><span id="p_name">--</span> &nbsp;|&nbsp; <strong>é›»è©±ï¼š</strong><span id="p_phone">--</span></p>
            <button class="btn-full" onclick="showBookingForm()">ğŸ“… æˆ‘è¦é ç´„</button>
            <br><br>
            <div class="btn-group">
                <button id="btnBooking" class="btn-outline active" onclick="switchTab('booking')">é ç´„ç´€éŒ„</button>
                <button id="btnConsumption" class="btn-outline" onclick="switchTab('consumption')">æ¶ˆè²»ç´€éŒ„</button>
            </div>
            <div id="listContainer" style="max-height: 200px; overflow-y: auto;"></div>
            <hr style="margin: 20px 0;">
            <button class="btn-outline" style="width:100%" onclick="logout()">ç™»å‡º</button>
        </div>

        <div id="bookingFormSection" class="hidden">
            <h3>ğŸ“ é ç´„å–®</h3>
            <input type="text" id="b_car_model" placeholder="è»Šç¨®">
            <select id="b_category"><option>ä¿é¤Š</option><option>ç¶­ä¿®</option><option>æ”¹è£</option></select>
            <input type="date" id="b_date_picker" onchange="updateTimeSlots()">
            <select id="b_time_slot" disabled><option>è«‹å…ˆé¸æ—¥æœŸ</option></select>
            <textarea id="b_note" rows="2" placeholder="å‚™è¨»..."></textarea>
            <div class="btn-group">
                <button class="btn-full" onclick="submitBooking()">é€å‡º</button>
                <button class="btn-outline" onclick="backToProfile()" style="margin-top:10px;">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <footer id="mainFooter">
        <div class="footer-links">
            <a href="https://line.me/ti/p/@ä½ çš„ID" target="_blank">å®˜æ–¹ LINE é ç´„</a> |
            <a href="https://instagram.com/ä½ çš„å¸³è™Ÿ" target="_blank">Instagram ä½œå“é›†</a> |
            <a href="https://facebook.com/ä½ çš„ç²‰å°ˆ" target="_blank">Facebook ç²‰çµ²åœ˜</a>
        </div>
        <p style="margin-top: 15px;">&copy; 2025 GF Motor. All Rights Reserved.</p>
        <p style="font-size: 0.8rem; color: #555;">å°ä¸­å¸‚è¥¿å±¯å€æŸæŸè·¯123è™Ÿ | ç‡Ÿæ¥­æ™‚é–“ï¼šé€±ä¸€è‡³é€±å…­ 13:00-22:00</p>
    </footer>

    <script>
        // --- é€™è£¡çš„ JavaScript é‚è¼¯å®Œå…¨ä¿æŒä¸è®Š ---
        const CLIENT_ID = "357528958616-1mbtrri5ii7irbqpftd8ml3qtdr7ho0u.apps.googleusercontent.com"; 
        let currentUserId = ""; 
        let isLoggedIn = false;

        function toggleLoginView() {
            const landing = document.getElementById("landingSection");
            const app = document.getElementById("appContainer");
            const navBtn = document.getElementById("navLoginBtn");
            const footer = document.getElementById("mainFooter"); // æŠ“å– footer

            if (isLoggedIn) {
                landing.classList.add("hidden");
                footer.classList.add("hidden"); // ç™»å…¥å¾Œéš±è— footer æ¯”è¼ƒä¹¾æ·¨
                app.classList.remove("hidden");
                showSection("profileSection");
                return;
            }

            if (app.classList.contains("hidden")) {
                landing.classList.add("hidden");
                footer.classList.add("hidden"); // é€²å…¥ç™»å…¥ç•«é¢æ™‚ä¹Ÿéš±è— footer
                app.classList.remove("hidden");
                showSection("loginSection");
                navBtn.innerText = "è¿”å›é¦–é ";
                navBtn.onclick = toggleLoginView;
            } else {
                landing.classList.remove("hidden");
                footer.classList.remove("hidden"); // è¿”å›é¦–é æ™‚é¡¯ç¤º footer
                app.classList.add("hidden");
                navBtn.innerText = "æœƒå“¡ç™»å…¥";
            }
        }

        async function handleCredentialResponse(response) {
            try {
                const res = await fetch("/auth/google", {
                    method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ token: response.credential })
                });
                const data = await res.json();

                if (data.action === "FILL_PHONE") {
                    currentUserId = data.google_id;
                    document.getElementById("userNameDisplay").innerText = data.user_name;
                    showSection("phoneSection");
                } else if (data.action === "GO_HOME") {
                    currentUserId = data.user.google_id;
                    isLoggedIn = true;
                    document.getElementById("navLoginBtn").innerText = "æœƒå“¡ä¸­å¿ƒ";
                    loadProfile();
                } else { alert("ç™»å…¥éŒ¯èª¤ï¼š" + data.detail); }
            } catch(e) { console.error(e); }
        }

        async function loadProfile() {
            showSection("profileSection");
            try {
                const res = await fetch(`/users/${currentUserId}`);
                const user = await res.json();
                document.getElementById("p_name").innerText = user.name;
                document.getElementById("p_phone").innerText = user.phone;
                updateLevelCard(user.level || "ä¸€èˆ¬æœƒå“¡", user.total_spending || 0);
                switchTab('booking');
            } catch(e) { console.error(e); }
        }

        function updateLevelCard(level, spending) {
            const card = document.getElementById("levelCard");
            card.className = "level-card"; 
            document.getElementById("p_level").innerText = level;
            document.getElementById("p_spending").innerText = spending.toLocaleString();
            let goal=0, name="";
            if (spending > 500000) { card.classList.add("svip-style"); goal=0; name="å·²å°é ‚"; }
            else if (spending > 300000) { card.classList.add("vvip-style"); goal=500000-spending; name="SVIP"; }
            else if (spending > 100000) { card.classList.add("bao-gai-style"); goal=300000-spending; name="VVIP"; }
            else if (spending > 50000) { card.classList.add("da-gai-style"); goal=100000-spending; name="çˆ†æ”¹"; }
            else { card.classList.add("normal-style"); goal=50000-spending; name="å¤§æ”¹"; }
            document.getElementById("next_goal").innerText = goal > 0 ? `${goal.toLocaleString()} (å‡ç´š${name})` : "å·²é”æœ€é«˜";
        }

        function showSection(id) {
            ["loginSection", "phoneSection", "profileSection", "bookingFormSection"].forEach(sid => document.getElementById(sid).classList.add("hidden"));
            document.getElementById(id).classList.remove("hidden");
        }

        async function submitPhone() {
            const phone = document.getElementById("phoneInput").value;
            if (!/^\d{10}$/.test(phone)) { alert("è«‹è¼¸å…¥10ç¢¼"); return; }
            const res = await fetch("/users/update-phone", { method: "PUT", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ google_id: currentUserId, phone: phone }) });
            if (res.ok) { isLoggedIn = true; loadProfile(); }
        }

        async function switchTab(tab) {
            const list = document.getElementById("listContainer");
            document.getElementById("btnBooking").classList.toggle("active", tab==='booking');
            document.getElementById("btnConsumption").classList.toggle("active", tab!=='booking');
            list.innerHTML = "è¼‰å…¥ä¸­...";
            const url = tab==='booking' ? `/my-bookings/${currentUserId}` : `/my-consumptions/${currentUserId}`;
            const res = await fetch(url);
            const data = await res.json();
            list.innerHTML = "";
            if(data.length===0) list.innerHTML = "<p style='text-align:center;color:#999'>ç„¡ç´€éŒ„</p>";
            data.forEach(item => {
                const d = new Date(item.created_at || item.booking_time).toLocaleDateString();
                const title = tab==='booking' ? `${item.category}-${item.car_model}` : item.description;
                const right = tab==='booking' ? item.status : `$${item.amount.toLocaleString()}`;
                list.innerHTML += `<div class="record-item"><div><strong>${title}</strong><br><small style='color:#888'>${d}</small></div><span>${right}</span></div>`;
            });
        }

        function showBookingForm() { showSection("bookingFormSection"); }
        function backToProfile() { showSection("profileSection"); switchTab('booking'); }
        function updateTimeSlots() { /* åŒå‰ */ 
            const dateInput = document.getElementById("b_date_picker").value;
            const slotSelect = document.getElementById("b_time_slot");
            slotSelect.innerHTML = ""; 
            if (!dateInput) { slotSelect.disabled = true; slotSelect.innerHTML = "<option>è«‹å…ˆé¸æ—¥æœŸ</option>"; return; }
            const day = new Date(dateInput).getDay();
            let start = 13, end = 21;
            if (day === 0) { slotSelect.innerHTML = "<option>æœ¬æ—¥å…¬ä¼‘</option>"; slotSelect.disabled = true; return; }
            if (day === 6) start = 11;
            slotSelect.disabled = false;
            for (let h = start; h <= end; h++) { const t = h.toString().padStart(2,'0') + ":00"; slotSelect.add(new Option(t, t)); }
        }
        async function submitBooking() { /* åŒå‰ */ 
             const date = document.getElementById("b_date_picker").value;
            const time = document.getElementById("b_time_slot").value;
            const car = document.getElementById("b_car_model").value;
            if(!date || !time || !car || document.getElementById("b_time_slot").disabled) { alert("è«‹å®Œæ•´å¡«å¯«"); return; }
            const payload = { user_google_id: currentUserId, car_model: car, booking_time: `${date}T${time}:00`, category: document.getElementById("b_category").value, note: document.getElementById("b_note").value };
            const res = await fetch("/bookings", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload) });
            if (res.ok) { alert("é ç´„æˆåŠŸ"); backToProfile(); } else { alert("å¤±æ•—"); }
        }
        function logout() { window.location.reload(); }

        window.onload = function() {
            google.accounts.id.initialize({ client_id: CLIENT_ID, callback: handleCredentialResponse });
            google.accounts.id.renderButton(document.getElementById("buttonDiv"), { theme: "outline", size: "large" });
        }
    </script>
</body>
</html>